<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysMedic | Intelligent Repair Core</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
     
    </style>
</head>
<body>

<div id="login-screen" class="login-screen">
    <div class="login-card">
        <div class="login-logo">
            <i class="fa-solid fa-biohazard"></i>
            <h2>SysMedic</h2>
        </div>
        <p>Intelligent Repair Core Authentication</p>
        <form onsubmit="handleLogin(event)">
            <div class="input-group">
                <i class="fa-solid fa-user"></i>
                <input type="text" id="login-username" placeholder="Username" required>
            </div>
            <div class="input-group">
                <i class="fa-solid fa-lock"></i>
                <input type="password" id="login-password" placeholder="Password" required>
            </div>
            <button type="submit" class="login-btn">Secure Login</button>
        </form>
    </div>
</div>

<div id="main-app" class="app-container hidden">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="toggle-btn" onclick="toggleSidebar()">
                <i class="fa-solid fa-bars"></i>
            </button>
            <div class="brand">
                <i class="fa-solid fa-biohazard logo-icon"></i>
                <span class="brand-text">SysMedic</span>
            </div>
        </div>
        
        <nav class="nav-menu">
            <button class="nav-item active" onclick="switchTab('dashboard')">
                <i class="fa-solid fa-house"></i>
                <span class="nav-text">Home</span>
            </button>
            <button class="nav-item" onclick="switchTab('chat')">
                <i class="fa-solid fa-comments-dollar"></i>
                <span class="nav-text">AI Chat</span>
            </button>
            <button class="nav-item" onclick="switchTab('support')">
                <i class="fa-solid fa-headset"></i>
                <span class="nav-text">Customer Support</span>
            </button>
            <button class="nav-item" onclick="switchTab('info')">
                <i class="fa-solid fa-circle-info"></i>
                <span class="nav-text">Info about PC</span>
            </button>
            <div class="spacer"></div>
            <button class="nav-item" onclick="switchTab('settings')">
                <i class="fa-solid fa-gear"></i>
                <span class="nav-text">Settings</span>
            </button>
            <button class="nav-item" onclick="switchTab('account')">
                <i class="fa-solid fa-user-circle"></i>
                <span class="nav-text">Account</span>
            </button>
        </nav>
    </aside>

    <main class="content">

        <section id="dashboard" class="tab-pane active">
            <header class="top-bar">
                <div>
                    <h1>System Dashboard</h1>
                    <p class="subtitle">Real-time health monitoring</p>
                </div>
                <div class="user-badge">Admin Access Granted</div>
            </header>

            <div class="vitals-grid">
                <div class="vital-card">
                    <i class="fa-solid fa-microchip icon-cpu"></i>
                    <div class="vital-info">
                        <span class="vital-label">CPU Load</span>
                        <span class="vital-value" id="cpu-val">0%</span>
                    </div>
                </div>
                <div class="vital-card">
                    <i class="fa-solid fa-memory icon-ram"></i>
                    <div class="vital-info">
                        <span class="vital-label">Memory Usage</span>
                        <span class="vital-value" id="ram-val">0 / 0 GB</span>
                    </div>
                </div>
                <div class="vital-card">
                    <i class="fa-solid fa-dumpster icon-disk"></i>
                    <div class="vital-info">
                        <span class="vital-label">Temp & Junk Files</span>
                        <span class="vital-value warning" id="temp-val">0 GB</span>
                    </div>
                </div>
            </div>

            <div class="action-section">
                <div class="heal-circle-container">
                    <button id="heal-btn" onclick="triggerHeal()">
                        <i class="fa-solid fa-power-off"></i>
                        <span>INITIATE SCAN</span>
                    </button>
                    <div class="pulse-ring"></div>
                </div>

                <div class="scan-stages hidden" id="scan-stages">
                    <div class="stage pending" id="stage-1">
                        <div class="stage-icon"><i class="fa-solid fa-terminal"></i></div>
                        <div class="stage-details">
                            <h4>Stage 1: Basic Command Fix</h4>
                            <p class="stage-status">Waiting...</p>
                        </div>
                    </div>
                    <div class="stage pending" id="stage-2">
                        <div class="stage-icon"><i class="fa-solid fa-shield-virus"></i></div>
                        <div class="stage-details">
                            <h4>Stage 2: Windows Defender Quick Scan</h4>
                            <p class="stage-status">Waiting...</p>
                        </div>
                    </div>
                    <div class="stage pending" id="stage-3">
                        <div class="stage-icon"><i class="fa-solid fa-rotate"></i></div>
                        <div class="stage-details">
                            <h4>Stage 3: OS & Driver Update Check</h4>
                            <p class="stage-status">Waiting...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="chat" class="tab-pane hidden">
            <header class="top-bar">
                <h1>Polyglot AI Assistant</h1>
                <div class="user-badge">Language: Auto-Detect</div>
            </header>
            <div class="chat-interface">
                <div class="chat-history" id="chat-history">
                    <div class="message bot">
                        <div class="avatar"><i class="fa-solid fa-robot"></i></div>
                        <div class="bubble">Hello! I am SysMedic. Describe your problem or upload a screenshot, and I will help you fix it.</div>
                    </div>
                </div>
                
                <div class="input-area" style="background: transparent; padding: 0;">
                    <div class="input-wrapper" id="chat-input-wrapper">
                        <div id="preview-area" class="preview-area">
                            <img id="image-preview" class="preview-thumb" src="" alt="Preview">
                            <div id="video-preview-text" style="color:white; font-size: 0.8rem; display:none;">Video Attached</div>
                            <button onclick="clearAttachment()" style="color: #ef4444; border:none; background:none; cursor:pointer; margin-left: 10px;"><i class="fa-solid fa-times"></i></button>
                        </div>

                        <div class="input-controls">
                            <input type="file" id="file-input" accept="image/*,video/*" hidden onchange="handleFileSelect(event)">
                            <button class="attach-btn" onclick="document.getElementById('file-input').click()" title="Attach Image/Video">
                                <i class="fa-solid fa-paperclip"></i>
                            </button>
                            <input type="text" id="user-input" placeholder="Type a message..." onkeypress="handleEnter(event)">
                            <button class="attach-btn" onclick="sendMessage()" style="color: #10b981;">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="info" class="tab-pane hidden">
            <div class="info-container">
                <div class="info-grid">
                    
                    <div class="info-card">
                        <div class="info-card-header">
                            <i class="fa-solid fa-id-card"></i> System Identity
                        </div>
                        <div class="device-list">
                            <div class="device-row"><span class="lbl">Manufacturer</span><span class="val" id="dev-manufacturer">Detecting...</span></div>
                            <div class="device-row"><span class="lbl">PC Name</span><span class="val" id="dev-model-name">...</span></div>
                            <div class="device-row"><span class="lbl">Serial ID</span><span class="val" id="dev-serial">...</span></div>
                            <div class="device-row"><span class="lbl">Architecture</span><span class="val" id="dev-arch">...</span></div>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-card-header">
                            <i class="fa-solid fa-network-wired"></i> Network & OS
                        </div>
                        <div class="device-list">
                            <div class="device-row"><span class="lbl">Local IP</span><span class="val" id="dev-ip">...</span></div>
                            <div class="device-row"><span class="lbl">OS Platform</span><span class="val" id="dev-platform">...</span></div>
                            <div class="device-row"><span class="lbl">System Uptime</span><span class="val" id="dev-uptime">...</span></div>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-card-header">
                            <i class="fa-solid fa-microchip"></i> Processor Details
                        </div>
                        <div class="device-list">
                            <div class="device-row"><span class="lbl">CPU Model</span><span class="val" id="dev-cpu">...</span></div>
                            <div class="device-row"><span class="lbl">Total Cores</span><span class="val" id="dev-cores">...</span></div> 
                            <div class="device-row"><span class="lbl">Installed RAM</span><span class="val" id="dev-ram">...</span></div>
                            <div class="device-row"><span class="lbl">GPU Model</span><span class="val" id="dev-gpu">...</span></div>
                            <div class="device-row"><span class="lbl">VRAM</span><span class="val" id="dev-vram">...</span></div>
                            <div class="device-row"><span class="lbl">Total Storage</span><span class="val" id="dev-ssd">...</span></div>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-card-header">
                            <i class="fa-solid fa-heart-pulse"></i> Resource Health
                        </div>
                        <div class="stat-circles">
                            <div class="circle-wrap">
                                <div class="circle-progress bat-prog" id="bat-ui-ring" style="width:100px; height:100px;">
                                    <div class="circle-inner" style="width:85px; height:85px;">
                                        <span id="dev-bat-percent" style="font-size:1rem;">...</span>
                                    </div>
                                </div>
                                <span class="circle-subtitle" id="dev-bat-time">Detecting...</span>
                            </div>
                            <div class="circle-wrap">
                                <div class="circle-progress hdd-prog" id="hdd-ui-ring" style="width:100px; height:100px;">
                                    <div class="circle-inner" style="width:85px; height:85px;">
                                        <span id="dev-hdd-percent" style="font-size:1rem;">...</span>
                                    </div>
                                </div>
                                <span class="circle-subtitle" id="dev-hdd-text">Detecting...</span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>      

        <section id="support" class="tab-pane hidden">
            <div class="tab-container"> <header class="top-bar">
                    <div>
                        <h1>Support Escalation</h1>
                        <p class="subtitle">Generate an AI-powered diagnostic report for human technicians</p>
                    </div>
                </header>

                <div class="info-card" style="text-align: center;">
                    <div class="info-card-header">
                        <i class="fa-solid fa-ticket"></i> AI Ticket Generator
                    </div>
                    
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 25px;">
                        SysMedic will analyze your system specs and recent chat history to create a professional technical brief.
                    </p>

                    <button class="btn-primary" id="btn-generate-ticket" onclick="generateSupportTicket()">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> Generate Ticket Summary
                    </button>
                    
                    <div id="ticket-output" class="ticket-box hidden" style="text-align: left; margin-top: 25px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); padding: 20px; border-radius: 12px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #60a5fa; white-space: pre-wrap;">
                    </div>
                    
                    <button class="btn-primary btn-success hidden" id="btn-send-ticket" onclick="sendSupportTicket()" style="margin-top: 20px; width: 100%; background: var(--success);">
                        <i class="fa-solid fa-paper-plane"></i> Dispatch to Support Team
                    </button>
                </div>
            </div>
        </section>

        <section id="settings" class="tab-pane hidden">
            <div class="tab-container">
                <div class="settings-wrapper">
            <header class="top-bar">
                <div>
                    <h1>Settings</h1>
                    <p class="subtitle">Customize your SysMedic experience</p>
                </div>
            </header>
            <div style="padding: 20px;">
                <h3 style="color: #94a3b8; font-size: 0.9rem; text-transform: uppercase; margin-bottom: 10px; margin-left: 5px;">Preferences</h3>
                <div class="settings-group">
                    <div class="setting-item">
                        <div><i class="fa-solid fa-envelope setting-icon"></i> Support Email</div>
                        <input type="email" id="acc-email" value="admin@sysmedic.local" 
                            style="background:transparent; border:none; color:var(--text-muted); text-align:right; outline:none;">
                    </div>
                </div>
                <div class="settings-group">
                    <div class="setting-item">
                        <div><i class="fa-solid fa-language setting-icon"></i> Language</div>
                        <div class="setting-value">English <i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div class="setting-item">
                        <div><i class="fa-solid fa-globe setting-icon"></i> App Language</div>
                        <div class="setting-value">System Default <i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div class="setting-item">
                        <div><i class="fa-solid fa-moon setting-icon"></i> Theme</div>
                        <div class="setting-value">Dark <i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div class="setting-item">
                        <div><i class="fa-solid fa-palette setting-icon"></i> Accent Color</div>
                        <div class="setting-value"><div class="color-circle"></div> <i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div class="setting-item">
                        <div><i class="fa-solid fa-keyboard setting-icon"></i> Keyboard Shortcuts</div>
                        <div class="setting-value"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                </div>

                <h3 style="color: #94a3b8; font-size: 0.9rem; text-transform: uppercase; margin-bottom: 10px; margin-left: 5px; margin-top: 30px;">About & Support</h3>
                <div class="settings-group">
                    <div class="setting-item">
                        <div><i class="fa-solid fa-bug setting-icon"></i> Report a Bug</div>
                        <div class="setting-value"><i class="fa-solid fa-arrow-up-right-from-square"></i></div>
                    </div>
                    <div class="setting-item">
                        <div><i class="fa-solid fa-circle-question setting-icon"></i> Help Center</div>
                        <div class="setting-value"><i class="fa-solid fa-arrow-up-right-from-square"></i></div>
                    </div>
                    <div class="setting-item">
                        <div><i class="fa-solid fa-file-contract setting-icon"></i> Terms of Use</div>
                        <div class="setting-value"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div class="setting-item">
                        <div><i class="fa-solid fa-shield-halved setting-icon"></i> Privacy Policy</div>
                        <div class="setting-value"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                </div>
            </div>
            </div>
            </div>
        </section>

        <section id="account" class="tab-pane hidden">
            <div class="tab-container">
                <div class="settings-wrapper">
            <header class="top-bar">
                <div>
                    <h1>Account Management</h1>
                    <p class="subtitle">Manage your profile and security parameters</p>
                </div>
            </header>
            <div style="padding: 20px;">
                <div class="info-card" style="margin-bottom: 30px; display: flex; align-items: center; gap: 20px;">
                    <div style="font-size: 3.5rem; color: #3b82f6; background: #1e293b; padding: 15px 25px; border-radius: 50%; border: 1px solid #334155;">
                        <i class="fa-solid fa-user-astronaut"></i>
                    </div>
                    <div>
                        <h2 style="color: white; margin: 0 0 5px 0;">Administrator</h2>
                        <p style="color: #94a3b8; margin: 0 0 10px 0;">admin@sysmedic.local</p>
                    </div>
                </div>

                <h3 style="color: #94a3b8; font-size: 0.9rem; text-transform: uppercase; margin-bottom: 10px; margin-left: 5px;">Security & Details</h3>
                <div class="settings-group">
                    <div class="setting-item">
                        <div><i class="fa-solid fa-envelope setting-icon"></i> Email Address</div>
                        <div class="setting-value">admin@sysmedic.local <i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div class="setting-item">
                        <div><i class="fa-solid fa-key setting-icon"></i> Change Password</div>
                        <div class="setting-value">Updated 2 days ago <i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div class="setting-item">
                        <div><i class="fa-solid fa-shield-check setting-icon"></i> Two-Factor Authentication</div>
                        <div class="setting-value" style="color: #10b981;">Enabled <i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                    <div class="setting-item">
                        <div><i class="fa-solid fa-id-card setting-icon"></i> License Key</div>
                        <div class="setting-value">XXXX-XXXX-XXXX-1234 <i class="fa-regular fa-copy" style="cursor: pointer;" onclick="alert('License Copied')"></i></div>
                    </div>
                </div>

                <div class="settings-group" style="border: 1px solid #7f1d1d; background: rgba(239, 68, 68, 0.05); margin-top: 30px;">
                    <div class="setting-item" onclick="alert('Are you sure you want to delete this account? This action cannot be undone.')">
                        <div><i class="fa-solid fa-trash setting-icon" style="color: #ef4444;"></i> Delete Account</div>
                        <div class="setting-value"><i class="fa-solid fa-chevron-right" style="color: #ef4444;"></i></div>
                    </div>
                </div>

                <button class="logout-btn" onclick="handleLogout()">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> Sign Out
                </button>
            </div>
            </div>
            </div>
        </section>
        
        <div class="app-footer">
            <div class="footer-left">
                <i class="fa-solid fa-shield-halved"></i> SysMedic Core v1.0.0
            </div>
            <div class="footer-right">
                <span class="status-dot"></span> System Connected
            </div>
        </div>
    </main>

    <div id="permission-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <i class="fa-solid fa-triangle-exclamation warning-icon"></i>
                <h2 id="modal-title">Action Required</h2>
            </div>
            <p id="modal-desc" style="white-space: pre-wrap;"></p>
            
            <div id="update-checklist" class="hidden" style="text-align: left; margin-bottom: 25px; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
            </div>
            
            <div class="modal-actions">
                <button class="btn-ignore" onclick="handleModalChoice(false)">Ignore</button>
                <button class="btn-resolve" onclick="handleModalChoice(true)">
                    <i class="fa-solid fa-shield-halved"></i> Resolve Issue
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function handleLogin(e) {
        e.preventDefault();
        const username = document.getElementById('login-username').value;
        const pass = document.getElementById('login-password').value;
        
        if (username && pass) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            switchTab('dashboard'); 
        }
    }
    function togglePasswordVisibility() {
    const passInput = document.getElementById('acc-app-pass');
    const toggleIcon = document.getElementById('togglePass');
    
    if (passInput.type === "password") {
        passInput.type = "text";
        toggleIcon.classList.replace('fa-eye', 'fa-eye-slash');
        passInput.style.color = "var(--accent)"; // Highlight when visible
    } else {
        passInput.type = "password";
        toggleIcon.classList.replace('fa-eye-slash', 'fa-eye');
        passInput.style.color = "var(--text-muted)";
    }
}
    function handleLogout() {
        document.getElementById('login-username').value = "";
        document.getElementById('login-password').value = "";
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
    }
</script>

<script>

    setInterval(() => { window.electronAPI.requestVitals(); }, 2000);

    window.electronAPI.onVitalsUpdate((data) => {
        document.getElementById('cpu-val').innerText = data.cpu;
        document.getElementById('ram-val').innerText = data.ram;
        document.getElementById('temp-val').innerText = data.temp;
        const cpuNum = parseInt(data.cpu);
        if (cpuNum > 80) document.getElementById('cpu-val').classList.add('warning');
        else document.getElementById('cpu-val').classList.remove('warning');
    });
    
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('expanded'); }

function switchTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        const targetTab = document.getElementById(tabId);
        if (targetTab) targetTab.classList.remove('hidden');

        // üëá TRIGGER DATA REQUEST WHEN OPENING INFO TAB üëá
        if (tabId === 'info') {
            window.electronAPI.requestPcInfo();
        }
        
        // This ensures the sidebar button stays highlighted
        const navBtn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
        if (navBtn) navBtn.classList.add('active');
    }

            async function updateBatteryUI() {
            if (!navigator.getBattery) return;
            try {
                const battery = await navigator.getBattery();
                const percent = Math.round(battery.level * 100);
                
                // Safety check: only update if the ID exists
                const percentEl = document.getElementById('dev-bat-percent');
                const ringEl = document.getElementById('bat-ui-ring');
                const timeEl = document.getElementById('dev-bat-time');

                if (percentEl) percentEl.innerText = percent + "%";
                if (ringEl) ringEl.style.background = `conic-gradient(#3b82f6 ${percent}%, #3f3f46 0)`;
                
                if (timeEl) {
                    const time = battery.dischargingTime;
                    timeEl.innerText = isFinite(time) ? 
                        `${Math.round(time / 60)} min remaining` : "Plugged In";
                }
            } catch (err) {
                console.warn("Battery API error:", err);
            }
        }

        // Ensure hardware data fills correctly
        window.electronAPI.onPcInfoData((data) => {
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.innerText = val || "N/A";
            };

            // Identity Card
            setVal('dev-manufacturer', data.manufacturer);
            setVal('dev-model-name', data.model);
            setVal('dev-serial', data.serial); // Now uses the simulated Serial ID
            setVal('dev-arch', data.arch);

            // Network & OS Card
            setVal('dev-ip', data.ip);
            setVal('dev-platform', data.platform); // Correctly fills OS Platform
            setVal('dev-uptime', data.uptime);

            // Hardware Card
            setVal('dev-cpu', data.processor);
            setVal('dev-cores', data.cores);
            setVal('dev-ram', data.ram);
            setVal('dev-gpu', data.gpu);
            setVal('dev-vram', data.vram);
            setVal('dev-ssd', data.ssd); // Fills Total Storage

            // Update Disk Usage Ring
            const hddRing = document.getElementById('hdd-ui-ring');
            const hddPercentTxt = document.getElementById('dev-hdd-percent');
            if (hddRing && data.ssd !== "Detecting...") {
                const total = parseInt(data.ssd);
                const used = data.ssdUsed || 0;
                const percent = total > 0 ? Math.round((used / total) * 100) : 0;
                
                if (hddPercentTxt) hddPercentTxt.innerText = percent + "%";
                hddRing.style.background = `conic-gradient(#10b981 ${percent}%, #3f3f46 0)`;
                setVal('dev-hdd-text', `${used} GB used / ${total} GB total`);
            }
            updateBatteryUI();
        });

    function showPlaceholder(feature) { alert(`${feature} feature coming soon!`); }

    // Heal Logic
    let scanPausedAtStage = 0; 
    function triggerHeal() {
        const btn = document.getElementById('heal-btn');
        document.getElementById('scan-stages').classList.remove('hidden');
        btn.classList.add('healing');
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i><span>SCANNING</span>';
        btn.disabled = true; 
        for(let i=1; i<=3; i++) updateStageUI(i, 'Waiting...', 'pending');

        updateStageUI(1, 'Initializing basic fixes...', 'active');
        window.electronAPI.startStage1();
    }    

    window.electronAPI.onStage1Progress((stepText) => {  updateStageUI(1, stepText, 'active'); });

    window.electronAPI.onStage1Complete(() => {
        updateStageUI(1, 'All basic services restored', 'completed');
        updateStageUI(2, 'Scanning files...', 'active');
        
        // Trigger the next secure bridge call
        window.electronAPI.startStage2Scan(); 
    });

    // --- SECURE STAGE 2 & 3 LOGIC ---

    // 1. Listen for a threat discovery
    window.electronAPI.onThreatDetected((data) => {
        updateStageUI(2, 'ACTION REQUIRED: Threat found!', 'warning');
        scanPausedAtStage = 2; 
        showModal("Threat Detected", `Windows Defender found '${data.threatName}' at location:\n${data.threatLocation}\n\nDo you want SysMedic to quarantine it safely?`);
    });

    // 2. Listen for a clean scan result
    window.electronAPI.onScan2Clean(() => {
        updateStageUI(2, 'No threats detected', 'completed');
        resumeScanToStage3(); 
    });

    // 3. Listen for a successful threat removal
    window.electronAPI.onThreatResolved(() => {
        updateStageUI(2, 'Threat removed successfully', 'completed');
        resumeScanToStage3();
    });

    // 4. Securely transition to Stage 3
    function resumeScanToStage3() {
        updateStageUI(3, 'Checking for updates...', 'active');
        
        // Use the secure bridge to trigger the next scan
        window.electronAPI.startStage3Scan();
    }

    window.electronAPI.onUpdatesFound((data) => {
        updateStageUI(3, 'ACTION REQUIRED: Updates available!', 'warning');
        scanPausedAtStage = 3; 
        
        const checklistDiv = document.getElementById('update-checklist');
        checklistDiv.innerHTML = '';
        checklistDiv.classList.remove('hidden'); 

        data.updates.forEach(upd => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.style.marginBottom = '10px';
            label.style.color = 'var(--text-main)';
            label.style.fontSize = '13px';
            label.style.cursor = 'pointer';
            label.innerHTML = `<input type="checkbox" value="${upd.id}" checked class="update-cb" style="margin-right: 10px; accent-color: var(--accent);"> ${upd.name}`;
            checklistDiv.appendChild(label);
        });

        showModal("System Updates Available", "Please select the updates you want to install:");
    });

    window.electronAPI.onUpdatesResolved(() => {
        updateStageUI(3, 'System is up to date', 'completed');
        finishScan();
    });

    function showModal(title, desc) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-desc').innerText = desc;
        document.getElementById('permission-modal').classList.remove('hidden');
    }
    
    function handleModalChoice(isApproved) {
        document.getElementById('permission-modal').classList.add('hidden');
        document.getElementById('update-checklist').classList.add('hidden'); 
        
        if (scanPausedAtStage === 2) {
            if (isApproved) {
                updateStageUI(2, 'Quarantining threat...', 'active');
                window.electronAPI.resolveThreat();
            } else {
                updateStageUI(2, 'Ignored by user', 'completed');
                resumeScanToStage3();
            }
        } else if (scanPausedAtStage === 3) {
            if (isApproved) {
                const checkboxes = document.querySelectorAll('.update-cb:checked');
                const selectedIds = Array.from(checkboxes).map(cb => cb.value);
                if (selectedIds.length === 0) {
                    updateStageUI(3, 'No updates selected', 'completed');
                    finishScan();
                    return;
                }
                updateStageUI(3, `Installing ${selectedIds.length} update(s)...`, 'active');
                window.electronAPI.resolveUpdates(selectedIds);
            } else {
                updateStageUI(3, 'Update skipped by user', 'completed');
                finishScan();
            }
        }
    }

    function finishScan() {
        const btn = document.getElementById('heal-btn');
        btn.classList.remove('healing');
        btn.innerHTML = '<i class="fa-solid fa-check"></i><span>SYSTEM HEALTHY</span>';
        btn.style.borderColor = "#10b981"; 
        btn.style.background = "radial-gradient(circle, #059669 0%, #064e3b 100%)";
        setTimeout(() => { 
            btn.disabled = false; btn.style.borderColor = ""; btn.style.background = "";
            btn.innerHTML = '<i class="fa-solid fa-power-off"></i><span>INITIATE SCAN</span>';
        }, 5000);
    }

    function updateStageUI(stageNum, text, status) {
        const st = document.getElementById('stage-' + stageNum);
        st.className = `stage ${status}`;
        st.querySelector('.stage-status').innerText = text;
        const iconContainer = st.querySelector('.stage-icon');
        if(status === 'completed') { iconContainer.innerHTML = '<i class="fa-solid fa-check"></i>'; st.style.borderColor = ""; } 
        else if (status === 'active') { iconContainer.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>'; st.style.borderColor = ""; } 
        else if (status === 'warning') { iconContainer.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i>'; st.style.borderColor = "#facc15"; iconContainer.style.background = "#facc15"; iconContainer.style.color = "#000"; } 
        else if (status === 'pending') { const icons = ['fa-terminal', 'fa-shield-virus', 'fa-rotate']; iconContainer.innerHTML = `<i class="fa-solid ${icons[stageNum-1]}"></i>`; }
    }
</script>

<script>
    let API_KEY = window.electronAPI.getApiKey();
    
    let workingModelName = null;
    let currentAttachment = null; 
    let conversationHistory = [];

    let recentSystemLogs = "Logs not yet loaded.";

    // Request the logs from the backend as soon as the app loads using the secure bridge
    window.electronAPI.requestSystemLogs();

    // Save them when the backend replies
    window.electronAPI.onSystemLogsData((logs) => {
        recentSystemLogs = logs;
        console.log("Fetched Windows Logs for AI:", recentSystemLogs);
    });

    let guideStack = []; 
    let stepTimer = null;
    let waitingForUserConfirmation = false;

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const base64Data = e.target.result.split(',')[1]; 
            const mimeType = file.type;
            currentAttachment = {
                mimeType: mimeType,
                data: base64Data,
                previewUrl: e.target.result,
                type: mimeType.startsWith('video') ? 'video' : 'image'
            };
            const previewArea = document.getElementById('preview-area');
            const imgPreview = document.getElementById('image-preview');
            const vidText = document.getElementById('video-preview-text');
            previewArea.style.display = 'flex';
            previewArea.style.alignItems = 'center';
            if (currentAttachment.type === 'image') {
                imgPreview.src = e.target.result;
                imgPreview.style.display = 'block';
                vidText.style.display = 'none';
            } else {
                imgPreview.style.display = 'none';
                vidText.style.display = 'block';
            }
        };
        reader.readAsDataURL(file);
    }

    function clearAttachment() {
        currentAttachment = null;
        document.getElementById('file-input').value = ""; 
        document.getElementById('preview-area').style.display = 'none';
    }

    function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

    function addMessage(text, sender, isLoading = false, attachment = null) {
        const history = document.getElementById('chat-history');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender}`;
        msgDiv.id = 'msg-' + Date.now();
        const icon = sender === 'bot' ? '<i class="fa-solid fa-robot"></i>' : '<i class="fa-solid fa-user"></i>';
        
        let formattedText = text;
        if (!isLoading && sender === 'bot') {
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); 
            formattedText = formattedText.replace(/\*(.*?)\*/g, '<i>$1</i>');     
            formattedText = formattedText.replace(/\n/g, '<br>');                 
        } else if (isLoading) {
            formattedText = `<i class="fa-solid fa-circle-notch fa-spin"></i> ${text}`;
        }

        let mediaHtml = '';
        if (attachment) {
            if (attachment.type === 'image') {
                mediaHtml = `<br><img src="${attachment.previewUrl}" alt="User Image">`;
            } else if (attachment.type === 'video') {
                mediaHtml = `<br><video controls src="${attachment.previewUrl}" style="max-width:100%"></video>`;
            }
        }

        msgDiv.innerHTML = `<div class="avatar">${icon}</div><div class="bubble">${formattedText}${mediaHtml}</div>`;
        history.appendChild(msgDiv);
        history.scrollTop = history.scrollHeight;
        return msgDiv.id;
    }

    async function getValidModel() {
        if(workingModelName) return workingModelName; 
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
            const data = await response.json();
            if(!data.models) throw new Error("No models returned.");

            const validModel = data.models.find(m => m.name.includes('gemini-1.5-flash'));
            if(validModel) { workingModelName = validModel.name; return workingModelName; }
            else { 
                const anyGemini = data.models.find(m => m.name.includes('gemini'));
                if(anyGemini) { workingModelName = anyGemini.name; return workingModelName; }
                throw new Error("No Gemini models found.");
            }
        } catch(e) { console.error(e); return "models/gemini-1.5-flash"; }
    }

    function startGuide(steps, topic) {
        guideStack.push({ steps: steps, index: 0, topic: topic });
        const inputWrapper = document.getElementById('chat-input-wrapper');
        inputWrapper.classList.add('interactive-active');
        if (guideStack.length > 1) {
            inputWrapper.classList.add('subguide-active'); 
            addMessage(`üîß **Detour:** Let's fix "${topic}" first, then go back to the main problem.`, 'bot');
        }
        showCurrentStep();
    }

    function showCurrentStep() {
        if (guideStack.length === 0) return;
        const currentGuide = guideStack[guideStack.length - 1]; 
        
        if (currentGuide.index >= currentGuide.steps.length) {
            guideStack.pop(); 
            if (guideStack.length > 0) {
                const parentGuide = guideStack[guideStack.length - 1];
                document.getElementById('chat-input-wrapper').classList.remove('subguide-active');
                addMessage(`‚úÖ "${currentGuide.topic}" resolved! Now back to **${parentGuide.topic}** (Step ${parentGuide.index + 1}).`, 'bot');
                showCurrentStep(); 
            } else {
                addMessage("‚úÖ All steps complete! Is your system fully repaired?", 'bot');
                document.getElementById('chat-input-wrapper').classList.remove('interactive-active');
                document.getElementById('chat-input-wrapper').classList.remove('subguide-active');
            }
            return;
        }

        const stepText = `üëâ **Step ${currentGuide.index + 1} (${currentGuide.topic}):** ${currentGuide.steps[currentGuide.index]} \n\n(Perform this now. I will ask you in 10s)`;
        addMessage(stepText, 'bot');
        waitingForUserConfirmation = true;

        if(stepTimer) clearTimeout(stepTimer);
        stepTimer = setTimeout(() => {
            if (waitingForUserConfirmation && guideStack.length > 0) {
                addMessage("‚è≥ **Have you done it?** (Type 'Yes' to continue, or tell me if you are stuck)", 'bot');
            }
        }, 10000); 
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        
        if (text === "" && !currentAttachment) return;

        addMessage(text, 'user', false, currentAttachment);
        input.value = "";
        
        if (guideStack.length > 0 && waitingForUserConfirmation) {
            const lower = text.toLowerCase();
            const yesWords = ['yes', 'done', 'ok', 'completed', 'finished', 'sure', 'found', 'fixed', 'solved'];
            const waitWords = ['no', 'wait', 'hold on', 'not yet', 'pause'];

            const isYes = yesWords.some(w => lower.includes(w) && lower.length < 15);
            const isWait = waitWords.some(w => lower.includes(w) && lower.length < 15);

            if (isYes) {
                waitingForUserConfirmation = false;
                clearTimeout(stepTimer);
                guideStack[guideStack.length - 1].index++;
                setTimeout(showCurrentStep, 500); 
                return;
            } 
            else if (isWait) {
                addMessage("Okay, no rush. Type 'Done' whenever you are ready.", 'bot');
                clearTimeout(stepTimer); 
                return;
            }
            else {
                clearTimeout(stepTimer);
                addMessage("üîç I see a sub-issue. Analyzing...", 'bot', true);
            }
        }

        const fileToSend = currentAttachment;
        clearAttachment();
        const loadingId = document.getElementById('msg-' + Date.now()) ? null : addMessage("Thinking...", 'bot', true);

        try {
            const modelName = await getValidModel();
            const url = `https://generativelanguage.googleapis.com/v1beta/${modelName}:generateContent?key=${API_KEY}`;
            
            let userParts = [];
            
            // Limit History to last 8 messages
            if (conversationHistory.length > 8) {
                conversationHistory = conversationHistory.slice(conversationHistory.length - 8);
            }

            if (conversationHistory.length === 0) {
                 userParts.push({ text: `
                    You are SysMedic, an expert IT diagnostic AI. 
                    
                    CURRENT WINDOWS SYSTEM ERRORS (Context):
                    ${recentSystemLogs}

                    Protocol:
                    1. When reporting a problem: Explain + Bullet Points. Use the provided System Errors if they seem relevant to the user's issue.
                    2. ALWAYS END WITH: "||Can I lead you to solve the issue?||"
                    
                    Interactive Guide:
                    If user says 'Yes' to leading, output JSON:
                    $$STEPS_START$$["Step 1", "Step 2"]$$STEPS_END$$

                    Nested Detour Protocol:
                    If the user is ALREADY inside a guide but reports a NEW error, 
                    generate a JSON for a SUB-GUIDE:
                    $$STEPS_START$$["Sub-Step 1", "Sub-Step 2"]$$STEPS_END$$
                `});
            }

            if (guideStack.length > 0 && waitingForUserConfirmation) {
                 const currentGuide = guideStack[guideStack.length - 1];
                 userParts.push({ text: `[SYSTEM: User is paused on Step ${currentGuide.index+1} of guide "${currentGuide.topic}". They reported:] ` + text });
            } else {
                 userParts.push({ text: text });
            }

            if (fileToSend && fileToSend.type === 'image') {
                userParts.push({
                    inlineData: { mimeType: fileToSend.mimeType, data: fileToSend.data }
                });
            }

            conversationHistory.push({ role: "user", parts: userParts });

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: conversationHistory })
            });

            if (response.status === 429) {
                throw new Error("You are chatting too fast! Please wait 1 minute to let the AI cool down.");
            }
            if (!response.ok) throw new Error(response.statusText);

            const data = await response.json();
            let aiText = data.candidates[0].content.parts[0].text;

            conversationHistory.push({ role: "model", parts: [{ text: aiText }] });

            if(loadingId && document.getElementById(loadingId)) document.getElementById(loadingId).remove();
            
            const snagBubbles = document.querySelectorAll('.message.bot');
            if(snagBubbles.length > 0) {
                const lastBubble = snagBubbles[snagBubbles.length - 1];
                if(lastBubble.innerText.includes("Analyzing...")) lastBubble.remove();
            }

            if (aiText.includes("$$STEPS_START$$")) {
                const jsonStr = aiText.split("$$STEPS_START$$")[1].split("$$STEPS_END$$")[0];
                try {
                    const steps = JSON.parse(jsonStr);
                    let topic = "Repair";
                    if (guideStack.length === 0) topic = "Main Issue";
                    else topic = "Sub-Issue"; 
                    
                    addMessage(`üöÄ Starting Guide for ${topic}...`, 'bot');
                    startGuide(steps, topic);
                } catch(e) {
                    addMessage(aiText.replace(/\$\$STEPS_START\$\$.*?\$\$STEPS_END\$\$/g, ""), 'bot');
                }
                return;
            }

            if (aiText.includes("||Can I lead you to solve the issue?||")) {
                aiText = aiText.replace(/\|\|/g, "");
                addMessage(aiText, 'bot');
                return;
            }

            addMessage(aiText, 'bot');

        } catch (error) {
            if(loadingId && document.getElementById(loadingId)) document.getElementById(loadingId).remove();
            console.error("SysMedic AI Error:", error);
            addMessage(`‚ö†Ô∏è Error: ${error.message}`, 'bot');
        }
    }

    // --- TICKET GENERATION LOGIC ---
    async function generateSupportTicket() {
    const btn = document.getElementById('btn-generate-ticket');
    const outputBox = document.getElementById('ticket-output');
    const sendBtn = document.getElementById('btn-send-ticket');

    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Analyzing Diagnostics...';
    btn.disabled = true;

    try {
        // 1. UPDATED: Pull system info using the new IDs
        const sysOS = document.getElementById('dev-platform')?.innerText || 'Windows 11';
        const sysCPU = document.getElementById('dev-cpu')?.innerText || 'Unknown Processor';
        const sysRAM = document.getElementById('dev-ram')?.innerText || 'Unknown RAM';

        // 2. Chat Log Extraction (Unchanged)
        let chatLogText = conversationHistory.length === 0 ? 
            "No previous chat history recorded." : 
            conversationHistory.map(msg => `[${msg.role.toUpperCase()}]: ${msg.parts[0].text}`).join('\n');

        // 3. Request Gemini Summary
        const modelName = await getValidModel();
        const url = `https://generativelanguage.googleapis.com/v1beta/${modelName}:generateContent?key=${API_KEY}`;
        
        const prompt = `
            You are a technical support summarizer. Create a professional IT support ticket.
            System Info: OS: ${sysOS}, CPU: ${sysCPU}, RAM: ${sysRAM}
            
            RECENT SYSTEM ERRORS:
            ${recentSystemLogs}

            Recent Chat Log: 
            ${chatLogText}

            Format strictly as:
            TICKET ID: SYSM-${Math.random().toString(36).substr(2, 6).toUpperCase()}
            TIMESTAMP: ${new Date().toLocaleString()}
            ISSUE: [1 paragraph summary of the user's problem]
            LOG ANALYSIS: [Briefly mention if any of the Recent System Errors explain the issue]
            AI-STEPS: [What the user already tried in the chat]
            ADVICE: [Next steps for a human agent]
        `;

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
        });

        if (!response.ok) throw new Error("AI Busy. Please try again in a moment.");

        const data = await response.json();
        const ticketText = data.candidates[0].content.parts[0].text;

        outputBox.innerText = ticketText;
        outputBox.classList.remove('hidden');
        sendBtn.classList.remove('hidden');
        btn.innerHTML = '<i class="fa-solid fa-rotate-right"></i> Regenerate Ticket';
        btn.disabled = false;

    } catch (error) {
        btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Generate Ticket Summary';
        btn.disabled = false;
        alert("Failed to generate ticket: " + error.message);
    }
}

function sendSupportTicket() {
    // 1. Grab Electron's shell module to open native apps
    const { shell } = require('electron'); 
    
    // 2. Get the generated ticket and manufacturer
    const ticketText = document.getElementById('ticket-output').innerText;
    const manufacturer = document.getElementById('dev-manufacturer')?.innerText || 'Unknown'; 

    // 3. Define the routing directory
    const supportDirectory = {
        'Lenovo': 'support@lenovo.com',
        'Dell Inc.': 'support@dell.com',
        'HP': 'support@hp.com'
    };
    
    // Determine the email, fallback to a local one if manufacturer isn't in the list
    const targetEmail = supportDirectory[manufacturer] || 'general-support@sysmedic.local';

    // 4. Format the email subject and body for a URL
    const subject = encodeURIComponent(`SysMedic Diagnostic Report - ${manufacturer}`);
    const body = encodeURIComponent(ticketText);

    // 5. Instantly open Windows Mail / Outlook with everything pre-filled
    shell.openExternal(`mailto:${targetEmail}?subject=${subject}&body=${body}`);
    
    // 6. Update the button UI to show it worked
    const sendBtn = document.getElementById('btn-send-ticket');
    sendBtn.innerHTML = '<i class="fa-solid fa-check"></i> Opened in Mail Client';
    sendBtn.style.background = "var(--success)";
    
    // Reset the button after 4 seconds
    setTimeout(() => {
        sendBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Dispatch to Support Team';
        sendBtn.style.background = "var(--accent)";
        sendBtn.disabled = false;
    }, 4000);
}
// Listen for the result from the backend
// window.electronAPI.onEmailSentStatus((result) => {
//     const sendBtn = document.getElementById('btn-send-ticket');
//     if (result.success) {
//         sendBtn.innerHTML = '<i class="fa-solid fa-check"></i> Dispatched to Manufacturer!';
//         sendBtn.style.background = "var(--success)";
        
//         setTimeout(() => {
//             sendBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Dispatch to Support Team';
//             sendBtn.disabled = false;
//         }, 4000);
//     } else {
//         sendBtn.innerHTML = '<i class="fa-solid fa-xmark"></i> Delivery Failed';
//         sendBtn.style.background = "var(--danger)";
//         sendBtn.disabled = false;
//     }
// });
</script>

</body>
</html>