<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysMedic | Intelligent Repair Core</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS FOR FILE UPLOADS */
        .input-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            background: #1e293b;
            border-radius: 12px;
            padding: 5px;
        }

        .preview-area {
            display: none; /* Hidden by default */
            padding: 10px;
            border-bottom: 1px solid #334155;
        }

        .preview-thumb {
            max-height: 80px;
            border-radius: 8px;
            border: 2px solid #3b82f6;
        }

        .input-controls {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .attach-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 15px;
            transition: color 0.3s;
        }

        .attach-btn:hover { color: #3b82f6; }

        .input-controls input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 15px;
            outline: none;
        }

        /* Chat bubble updates */
        .bubble img, .bubble video {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #475569;
        }
        
        .bubble {
            white-space: pre-wrap; 
            line-height: 1.5;
        }
        .bubble strong, .bubble b { font-weight: 700; color: #fff; }
        
        /* Interactive Mode Highlight */
        .interactive-active {
            border: 2px solid #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }
        
        /* Sub-Guide Highlight (Orange) */
        .subguide-active {
            border: 2px solid #f59e0b !important;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3) !important;
        }

        /* NEW: Action Buttons in Chat */
        .chat-action-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .chat-action-btn:hover { background: #059669; }
        .chat-action-btn i { margin-right: 5px; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="toggle-btn" onclick="toggleSidebar()">
                <i class="fa-solid fa-bars"></i>
            </button>
            <div class="brand">
                <i class="fa-solid fa-biohazard logo-icon"></i>
                <span class="brand-text">SysMedic</span>
            </div>
        </div>
        
        <nav class="nav-menu">
            <button class="nav-item active" onclick="switchTab('dashboard')">
                <i class="fa-solid fa-house"></i>
                <span class="nav-text">Home</span>
            </button>
            <button class="nav-item" onclick="switchTab('chat')">
                <i class="fa-solid fa-comments-dollar"></i>
                <span class="nav-text">AI Chat</span>
            </button>
            <button class="nav-item" onclick="showPlaceholder('Customer Support Ticket Generation')">
                <i class="fa-solid fa-headset"></i>
                <span class="nav-text">Customer Support</span>
            </button>
            <button class="nav-item" onclick="showPlaceholder('Info about PC')">
                <i class="fa-solid fa-circle-info"></i>
                <span class="nav-text">Info about PC</span>
            </button>
            <div class="spacer"></div>
            <button class="nav-item" onclick="showPlaceholder('Settings')">
                <i class="fa-solid fa-gear"></i>
                <span class="nav-text">Settings</span>
            </button>
            <button class="nav-item" onclick="showPlaceholder('Account Management')">
                <i class="fa-solid fa-user-circle"></i>
                <span class="nav-text">Account</span>
            </button>
        </nav>
    </aside>

    <main class="content">

        <section id="dashboard" class="tab-pane active">
            <header class="top-bar">
                <div>
                    <h1>System Dashboard</h1>
                    <p class="subtitle">Real-time health monitoring</p>
                </div>
                <div class="user-badge">Admin Access Granted</div>
            </header>

            <div class="vitals-grid">
                <div class="vital-card">
                    <i class="fa-solid fa-microchip icon-cpu"></i>
                    <div class="vital-info">
                        <span class="vital-label">CPU Load</span>
                        <span class="vital-value" id="cpu-val">0%</span>
                    </div>
                </div>
                <div class="vital-card">
                    <i class="fa-solid fa-memory icon-ram"></i>
                    <div class="vital-info">
                        <span class="vital-label">Memory Usage</span>
                        <span class="vital-value" id="ram-val">0 / 0 GB</span>
                    </div>
                </div>
                <div class="vital-card">
                    <i class="fa-solid fa-dumpster icon-disk"></i>
                    <div class="vital-info">
                        <span class="vital-label">Temp & Junk Files</span>
                        <span class="vital-value warning" id="temp-val">0 GB</span>
                    </div>
                </div>
            </div>

            <div class="action-section">
                <div class="heal-circle-container">
                    <button id="heal-btn" onclick="triggerHeal()">
                        <i class="fa-solid fa-power-off"></i>
                        <span>INITIATE SCAN</span>
                    </button>
                    <div class="pulse-ring"></div>
                </div>

                <div class="scan-stages hidden" id="scan-stages">
                    <div class="stage pending" id="stage-1">
                        <div class="stage-icon"><i class="fa-solid fa-terminal"></i></div>
                        <div class="stage-details">
                            <h4>Stage 1: Basic Command Fix</h4>
                            <p class="stage-status">Waiting...</p>
                        </div>
                    </div>
                    <div class="stage pending" id="stage-2">
                        <div class="stage-icon"><i class="fa-solid fa-shield-virus"></i></div>
                        <div class="stage-details">
                            <h4>Stage 2: Windows Defender Quick Scan</h4>
                            <p class="stage-status">Waiting...</p>
                        </div>
                    </div>
                    <div class="stage pending" id="stage-3">
                        <div class="stage-icon"><i class="fa-solid fa-rotate"></i></div>
                        <div class="stage-details">
                            <h4>Stage 3: OS & Driver Update Check</h4>
                            <p class="stage-status">Waiting...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="chat" class="tab-pane hidden">
            <header class="top-bar">
                <h1>Polyglot AI Assistant</h1>
                <div class="user-badge">Language: Auto-Detect</div>
            </header>
            <div class="chat-interface">
                <div class="chat-history" id="chat-history">
                    <div class="message bot">
                        <div class="avatar"><i class="fa-solid fa-robot"></i></div>
                        <div class="bubble">Hello! I am SysMedic. Describe your problem or upload a screenshot.</div>
                    </div>
                </div>
                
                <div class="input-area" style="background: transparent; padding: 0;">
                    <div class="input-wrapper" id="chat-input-wrapper">
                        <div id="preview-area" class="preview-area">
                            <img id="image-preview" class="preview-thumb" src="" alt="Preview">
                            <div id="video-preview-text" style="color:white; font-size: 0.8rem; display:none;">Video Attached</div>
                            <button onclick="clearAttachment()" style="color: #ef4444; border:none; background:none; cursor:pointer; margin-left: 10px;"><i class="fa-solid fa-times"></i></button>
                        </div>

                        <div class="input-controls">
                            <input type="file" id="file-input" accept="image/*,video/*" hidden onchange="handleFileSelect(event)">
                            
                            <button class="attach-btn" onclick="document.getElementById('file-input').click()" title="Attach Image/Video">
                                <i class="fa-solid fa-paperclip"></i>
                            </button>
                            
                            <input type="text" id="user-input" placeholder="Type a message..." onkeypress="handleEnter(event)">
                            
                            <button class="attach-btn" onclick="sendMessage()" style="color: #10b981;">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div id="permission-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <i class="fa-solid fa-triangle-exclamation warning-icon"></i>
                <h2 id="modal-title">Action Required</h2>
            </div>
            <p id="modal-desc" style="white-space: pre-wrap;"></p>
            
            <div id="update-checklist" class="hidden" style="text-align: left; margin-bottom: 25px; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
            </div>
            
            <div class="modal-actions">
                <button class="btn-ignore" onclick="handleModalChoice(false)">Ignore</button>
                <button class="btn-resolve" onclick="handleModalChoice(true)">
                    <i class="fa-solid fa-shield-halved"></i> Resolve Issue
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const { ipcRenderer } = require('electron');

    // --- DASHBOARD VITALS LOGIC ---
    setInterval(() => {
        ipcRenderer.send('request-vitals');
    }, 2000);

    ipcRenderer.on('vitals-update', (event, data) => {
        document.getElementById('cpu-val').innerText = data.cpu;
        document.getElementById('ram-val').innerText = data.ram;
        document.getElementById('temp-val').innerText = data.temp;

        const cpuNum = parseInt(data.cpu);
        if (cpuNum > 80) {
            document.getElementById('cpu-val').classList.add('warning');
        } else {
            document.getElementById('cpu-val').classList.remove('warning');
        }
    });
    
    // --- SIDEBAR TOGGLE LOGIC ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('expanded');
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    }
    
    function showPlaceholder(feature) { alert(`${feature} feature coming soon!`); }

    // Heal Logic
    let scanPausedAtStage = 0; 
    function triggerHeal() {
        const btn = document.getElementById('heal-btn');
        document.getElementById('scan-stages').classList.remove('hidden');
        btn.classList.add('healing');
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i><span>SCANNING</span>';
        btn.disabled = true; 
        for(let i=1; i<=3; i++) updateStageUI(i, 'Waiting...', 'pending');

        // Start Stage 1 (Text will be updated by the backend!)
        updateStageUI(1, 'Initializing basic fixes...', 'active');
        ipcRenderer.send('start-stage-1');
    }    

    // NEW LISTENER: Stage 1 Live Progress
    ipcRenderer.on('stage-1-progress', (event, stepText) => {
        updateStageUI(1, stepText, 'active');
    });

    // LISTENER: Stage 1 Done -> Start Stage 2
    ipcRenderer.on('stage-1-complete', (event, response) => {
        updateStageUI(1, 'All basic services restored', 'completed');
        
        // Start Stage 2
        updateStageUI(2, 'Scanning files...', 'active');
        ipcRenderer.send('start-stage-2-scan'); 
    });

    ipcRenderer.on('threat-detected', (event, data) => {
        updateStageUI(2, 'ACTION REQUIRED: Threat found!', 'warning');
        scanPausedAtStage = 2; 
        
        showModal(
            "Threat Detected", 
            `Windows Defender found '${data.threatName}' at location:\n${data.threatLocation}\n\nDo you want SysMedic to quarantine it safely?`
        );
    });

    ipcRenderer.on('scan-2-clean', (event) => {
        updateStageUI(2, 'No threats detected', 'completed');
        resumeScanToStage3(); 
    });

    ipcRenderer.on('threat-resolved', (event, response) => {
        updateStageUI(2, 'Threat removed successfully', 'completed');
        resumeScanToStage3();
    });

    function resumeScanToStage3() {
        updateStageUI(3, 'Checking for updates...', 'active');
        ipcRenderer.send('start-stage-3-scan');
    }

    ipcRenderer.on('updates-found', (event, data) => {
        updateStageUI(3, 'ACTION REQUIRED: Updates available!', 'warning');
        scanPausedAtStage = 3; 
        
        const checklistDiv = document.getElementById('update-checklist');
        checklistDiv.innerHTML = '';
        checklistDiv.classList.remove('hidden'); 

        data.updates.forEach(upd => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.style.marginBottom = '10px';
            label.style.color = 'var(--text-main)';
            label.style.fontSize = '13px';
            label.style.cursor = 'pointer';
            
            label.innerHTML = `<input type="checkbox" value="${upd.id}" checked class="update-cb" style="margin-right: 10px; accent-color: var(--accent);"> ${upd.name}`;
            checklistDiv.appendChild(label);
        });

        showModal("System Updates Available", "Please select the updates you want to install:");
    });

    ipcRenderer.on('updates-resolved', (event) => {
        updateStageUI(3, 'System is up to date', 'completed');
        finishScan();
    });

    // --- MODAL LOGIC ---
    function showModal(title, desc) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-desc').innerText = desc;
        document.getElementById('permission-modal').classList.remove('hidden');
    }
    function handleModalChoice(isApproved) {
        document.getElementById('permission-modal').classList.add('hidden');
        document.getElementById('update-checklist').classList.add('hidden'); 
        
        if (scanPausedAtStage === 2) {
            if (isApproved) {
                updateStageUI(2, 'Quarantining threat...', 'active');
                ipcRenderer.send('resolve-threat'); 
            } else {
                updateStageUI(2, 'Ignored by user', 'completed');
                resumeScanToStage3();
            }
        } else if (scanPausedAtStage === 3) {
            if (isApproved) {
                const checkboxes = document.querySelectorAll('.update-cb:checked');
                const selectedIds = Array.from(checkboxes).map(cb => cb.value);

                if (selectedIds.length === 0) {
                    updateStageUI(3, 'No updates selected', 'completed');
                    finishScan();
                    return;
                }

                updateStageUI(3, `Installing ${selectedIds.length} update(s)...`, 'active');
                ipcRenderer.send('resolve-updates', selectedIds); 
            } else {
                updateStageUI(3, 'Update skipped by user', 'completed');
                finishScan();
            }
        }
    }

    function finishScan() {
        const btn = document.getElementById('heal-btn');
        btn.classList.remove('healing');
        btn.innerHTML = '<i class="fa-solid fa-check"></i><span>SYSTEM HEALTHY</span>';
        btn.style.borderColor = "#10b981"; 
        btn.style.background = "radial-gradient(circle, #059669 0%, #064e3b 100%)";
        setTimeout(() => { 
            btn.disabled = false; btn.style.borderColor = ""; btn.style.background = "";
            btn.innerHTML = '<i class="fa-solid fa-power-off"></i><span>INITIATE SCAN</span>';
        }, 5000);
    }

    function updateStageUI(stageNum, text, status) {
        const st = document.getElementById('stage-' + stageNum);
        st.className = `stage ${status}`;
        st.querySelector('.stage-status').innerText = text;
        const iconContainer = st.querySelector('.stage-icon');
        if(status === 'completed') { iconContainer.innerHTML = '<i class="fa-solid fa-check"></i>'; st.style.borderColor = ""; } 
        else if (status === 'active') { iconContainer.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>'; st.style.borderColor = ""; } 
        else if (status === 'warning') { iconContainer.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i>'; st.style.borderColor = "#facc15"; iconContainer.style.background = "#facc15"; iconContainer.style.color = "#000"; } 
        else if (status === 'pending') { const icons = ['fa-terminal', 'fa-shield-virus', 'fa-rotate']; iconContainer.innerHTML = `<i class="fa-solid ${icons[stageNum-1]}"></i>`; }
    }
</script>

<script>
    // 3. GRAB KEY SECURELY
    // const API_KEY = window.process.argv.find(arg => arg.startsWith('--api-key=')).split('=')[1];
    let API_KEY = "MISSING_KEY";
    try {
        const keyArg = process.argv.find(arg => arg.startsWith('--api-key='));
        if (keyArg) {
            API_KEY = keyArg.split('=')[1];
        } else {
            console.warn("‚ö†Ô∏è SysMedic Warning: API Key argument not found!");
        }
    } catch (error) {
        console.error("‚ö†Ô∏è SysMedic Error reading process.argv:", error);
    }
    let workingModelName = null;
    let currentAttachment = null; 
    let conversationHistory = []; // Limit history to last 10 turns to save tokens

    // --- NESTED GUIDE STACK ---
    let guideStack = []; 
    let stepTimer = null;
    let waitingForUserConfirmation = false;

    // --- FILE HANDLING LOGIC ---
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const base64Data = e.target.result.split(',')[1]; 
            const mimeType = file.type;
            currentAttachment = {
                mimeType: mimeType,
                data: base64Data,
                previewUrl: e.target.result,
                type: mimeType.startsWith('video') ? 'video' : 'image'
            };
            const previewArea = document.getElementById('preview-area');
            const imgPreview = document.getElementById('image-preview');
            const vidText = document.getElementById('video-preview-text');
            previewArea.style.display = 'flex';
            previewArea.style.alignItems = 'center';
            if (currentAttachment.type === 'image') {
                imgPreview.src = e.target.result;
                imgPreview.style.display = 'block';
                vidText.style.display = 'none';
            } else {
                imgPreview.style.display = 'none';
                vidText.style.display = 'block';
            }
        };
        reader.readAsDataURL(file);
    }

    function clearAttachment() {
        currentAttachment = null;
        document.getElementById('file-input').value = ""; 
        document.getElementById('preview-area').style.display = 'none';
    }

    // --- UI HELPERS ---
    function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

    function addMessage(text, sender, isLoading = false, attachment = null, showDoneButton = false) {
        const history = document.getElementById('chat-history');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender}`;
        msgDiv.id = 'msg-' + Date.now();
        const icon = sender === 'bot' ? '<i class="fa-solid fa-robot"></i>' : '<i class="fa-solid fa-user"></i>';
        
        let formattedText = text;
        if (!isLoading && sender === 'bot') {
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); 
            formattedText = formattedText.replace(/\*(.*?)\*/g, '<i>$1</i>');     
            formattedText = formattedText.replace(/\n/g, '<br>');                 
        } else if (isLoading) {
            formattedText = `<i class="fa-solid fa-circle-notch fa-spin"></i> ${text}`;
        }

        let mediaHtml = '';
        if (attachment) {
            if (attachment.type === 'image') {
                mediaHtml = `<br><img src="${attachment.previewUrl}" alt="User Image">`;
            } else if (attachment.type === 'video') {
                mediaHtml = `<br><video controls src="${attachment.previewUrl}" style="max-width:100%"></video>`;
            }
        }

        // ADD "DONE" BUTTON IF REQUESTED
        let btnHtml = '';
        if (showDoneButton) {
            btnHtml = `<br><button class="chat-action-btn" onclick="triggerUserDone()"><i class="fa-solid fa-check"></i> Task Completed</button>`;
        }

        msgDiv.innerHTML = `<div class="avatar">${icon}</div><div class="bubble">${formattedText}${mediaHtml}${btnHtml}</div>`;
        history.appendChild(msgDiv);
        history.scrollTop = history.scrollHeight;
        return msgDiv.id;
    }

    // Function to simulate user typing "Done"
    window.triggerUserDone = function() {
        const input = document.getElementById('user-input');
        input.value = "Done";
        sendMessage();
    };

    // --- MODEL FINDER ---
    async function getValidModel() {
        if(workingModelName) return workingModelName; 
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
            const data = await response.json();
            if(!data.models) throw new Error("No models returned.");

            const validModel = data.models.find(m => m.name.includes('gemini-1.5-flash'));
            if(validModel) { workingModelName = validModel.name; return workingModelName; }
            else { 
                const anyGemini = data.models.find(m => m.name.includes('gemini'));
                if(anyGemini) { workingModelName = anyGemini.name; return workingModelName; }
                throw new Error("No Gemini models found.");
            }
        } catch(e) { console.error(e); return "models/gemini-1.5-flash"; }
    }

    // --- NESTED GUIDE LOGIC ---
    function startGuide(steps, topic) {
        guideStack.push({ steps: steps, index: 0, topic: topic });
        
        const inputWrapper = document.getElementById('chat-input-wrapper');
        inputWrapper.classList.add('interactive-active');
        if (guideStack.length > 1) {
            inputWrapper.classList.add('subguide-active');
            addMessage(`üîß **Detour:** Fixing "${topic}" first...`, 'bot');
        }
        showCurrentStep();
    }

    function showCurrentStep() {
        if (guideStack.length === 0) return;
        const currentGuide = guideStack[guideStack.length - 1];
        
        if (currentGuide.index >= currentGuide.steps.length) {
            guideStack.pop();
            if (guideStack.length > 0) {
                const parentGuide = guideStack[guideStack.length - 1];
                document.getElementById('chat-input-wrapper').classList.remove('subguide-active');
                addMessage(`‚úÖ "${currentGuide.topic}" done! Returning to **${parentGuide.topic}** (Step ${parentGuide.index + 1}).`, 'bot');
                showCurrentStep(); 
            } else {
                addMessage("‚úÖ All steps complete! System repaired.", 'bot');
                document.getElementById('chat-input-wrapper').classList.remove('interactive-active');
                document.getElementById('chat-input-wrapper').classList.remove('subguide-active');
            }
            return;
        }

        const stepText = `üëâ **Step ${currentGuide.index + 1} (${currentGuide.topic}):** ${currentGuide.steps[currentGuide.index]}`;
        
        // Show step WITH the button
        addMessage(stepText, 'bot', false, null, true);
        
        waitingForUserConfirmation = true;
    }

    // --- MAIN SEND FUNCTION ---
    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (text === "" && !currentAttachment) return;

        addMessage(text, 'user', false, currentAttachment);
        input.value = "";
        
        // --- INTERACTIVE CHECK (Updated with Smarter "Yes") ---
        if (guideStack.length > 0 && waitingForUserConfirmation) {
            const lower = text.toLowerCase();
            const yesWords = ['yes', 'done', 'ok', 'completed', 'finished', 'sure', 'found', 'fixed', 'solved'];
            const waitWords = ['no', 'wait', 'hold on', 'not yet', 'pause'];

            const isYes = yesWords.some(w => lower.includes(w) && lower.length < 20);
            const isWait = waitWords.some(w => lower.includes(w) && lower.length < 15);

            if (isYes) {
                waitingForUserConfirmation = false;
                guideStack[guideStack.length - 1].index++;
                setTimeout(showCurrentStep, 500); 
                return;
            } 
            else if (isWait) {
                addMessage("Okay, click 'Task Completed' when ready.", 'bot');
                return;
            }
            else {
                addMessage("üîç Analyzing sub-issue...", 'bot', true);
            }
        }

        // --- PREPARE PAYLOAD ---
        const fileToSend = currentAttachment;
        clearAttachment();
        const loadingId = document.getElementById('msg-' + Date.now()) ? null : addMessage("Thinking...", 'bot', true);

        try {
            const modelName = await getValidModel();
            const url = `https://generativelanguage.googleapis.com/v1beta/${modelName}:generateContent?key=${API_KEY}`;
            
            let userParts = [];
            
            // Limit History to last 8 messages (Prevents 429 Error on long chats)
            if (conversationHistory.length > 8) {
                conversationHistory = conversationHistory.slice(conversationHistory.length - 8);
            }

            if (conversationHistory.length === 0) {
                 userParts.push({ text: `
                    You are SysMedic. 
                    Protocol:
                    1. When reporting problem: Explain + Bullet Points.
                    2. ALWAYS END WITH: "||Can I lead you to solve the issue?||"
                    
                    Interactive Guide:
                    If user says 'Yes', output JSON:
                    $$STEPS_START$$["Step 1", "Step 2"]$$STEPS_END$$

                    Nested Detour Protocol:
                    If user is IN a guide but reports a NEW error (e.g. "I can't find it"), 
                    generate a JSON for a SUB-GUIDE:
                    $$STEPS_START$$["Sub-Step 1", "Sub-Step 2"]$$STEPS_END$$
                `});
            }

            if (guideStack.length > 0 && waitingForUserConfirmation) {
                 const currentGuide = guideStack[guideStack.length - 1];
                 userParts.push({ text: `[SYSTEM: User is paused on Step ${currentGuide.index+1} of guide "${currentGuide.topic}". They reported:] ` + text });
            } else {
                 userParts.push({ text: text });
            }

            if (fileToSend && fileToSend.type === 'image') {
                userParts.push({ inlineData: { mimeType: fileToSend.mimeType, data: fileToSend.data } });
            }

            conversationHistory.push({ role: "user", parts: userParts });

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: conversationHistory })
            });

            // --- 429 ERROR HANDLING ---
            if (response.status === 429) {
                throw new Error("You are chatting too fast! Please wait 1 minute.");
            }
            if (!response.ok) throw new Error(response.statusText);

            const data = await response.json();
            let aiText = data.candidates[0].content.parts[0].text;

            conversationHistory.push({ role: "model", parts: [{ text: aiText }] });

            if(loadingId && document.getElementById(loadingId)) document.getElementById(loadingId).remove();
            
            // Remove snag bubble
            const bubbles = document.querySelectorAll('.message.bot');
            if(bubbles.length > 0 && bubbles[bubbles.length-1].innerText.includes("Analyzing")) {
                bubbles[bubbles.length-1].remove();
            }

            if (aiText.includes("$$STEPS_START$$")) {
                const jsonStr = aiText.split("$$STEPS_START$$")[1].split("$$STEPS_END$$")[0];
                try {
                    const steps = JSON.parse(jsonStr);
                    let topic = guideStack.length === 0 ? "Main Repair" : "Sub-Repair";
                    addMessage(`üöÄ Starting Guide for ${topic}...`, 'bot');
                    startGuide(steps, topic);
                } catch(e) {
                    addMessage(aiText.replace(/\$\$STEPS_START\$\$.*?\$\$STEPS_END\$\$/g, ""), 'bot');
                }
                return;
            }

            if (aiText.includes("||Can I lead you to solve the issue?||")) {
                aiText = aiText.replace(/\|\|/g, "");
                addMessage(aiText, 'bot');
                return;
            }

            addMessage(aiText, 'bot');

        } catch (error) {
            if(loadingId && document.getElementById(loadingId)) document.getElementById(loadingId).remove();
            console.error("SysMedic AI Error:", error);
            addMessage(`‚ö†Ô∏è Error: ${error.message}`, 'bot');
        }
    }
</script>

</body>
</html>