<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysMedic | Intelligent Repair Core</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="toggle-btn" onclick="toggleSidebar()">
                <i class="fa-solid fa-bars"></i>
            </button>
            <div class="brand">
                <i class="fa-solid fa-biohazard logo-icon"></i>
                <span class="brand-text">SysMedic</span>
            </div>
        </div>
        
        <nav class="nav-menu">
            <button class="nav-item active" onclick="switchTab('dashboard')">
                <i class="fa-solid fa-house"></i>
                <span class="nav-text">Home</span>
            </button>
            <button class="nav-item" onclick="switchTab('chat')">
                <i class="fa-solid fa-comments-dollar"></i>
                <span class="nav-text">AI Chat</span>
            </button>
            <button class="nav-item" onclick="showPlaceholder('Customer Support Ticket Generation')">
                <i class="fa-solid fa-headset"></i>
                <span class="nav-text">Customer Support</span>
            </button>
            <button class="nav-item" onclick="showPlaceholder('Info about PC')">
                <i class="fa-solid fa-circle-info"></i>
                <span class="nav-text">Info about PC</span>
            </button>
            <div class="spacer"></div>
            <button class="nav-item" onclick="showPlaceholder('Settings')">
                <i class="fa-solid fa-gear"></i>
                <span class="nav-text">Settings</span>
            </button>
            <button class="nav-item" onclick="showPlaceholder('Account Management')">
                <i class="fa-solid fa-user-circle"></i>
                <span class="nav-text">Account</span>
            </button>
        </nav>
    </aside>

    <main class="content">

        <section id="dashboard" class="tab-pane active">
            <header class="top-bar">
                <div>
                    <h1>System Dashboard</h1>
                    <p class="subtitle">Real-time health monitoring</p>
                </div>
                <div class="user-badge">Admin Access Granted</div>
            </header>

            <div class="vitals-grid">
                <div class="vital-card">
                    <i class="fa-solid fa-microchip icon-cpu"></i>
                    <div class="vital-info">
                        <span class="vital-label">CPU Load</span>
                        <span class="vital-value" id="cpu-val">0%</span>
                    </div>
                </div>
                <div class="vital-card">
                    <i class="fa-solid fa-memory icon-ram"></i>
                    <div class="vital-info">
                        <span class="vital-label">Memory Usage</span>
                        <span class="vital-value" id="ram-val">0 / 0 GB</span>
                    </div>
                </div>
                <div class="vital-card">
                    <i class="fa-solid fa-dumpster icon-disk"></i>
                    <div class="vital-info">
                        <span class="vital-label">Temp & Junk Files</span>
                        <span class="vital-value warning" id="temp-val">0 GB</span>
                    </div>
                </div>
            </div>

            <div class="action-section">
                <div class="heal-circle-container">
                    <button id="heal-btn" onclick="triggerHeal()">
                        <i class="fa-solid fa-power-off"></i>
                        <span>INITIATE SCAN</span>
                    </button>
                    <div class="pulse-ring"></div>
                </div>

                <div class="scan-stages hidden" id="scan-stages">
                    <div class="stage pending" id="stage-1">
                        <div class="stage-icon"><i class="fa-solid fa-terminal"></i></div>
                        <div class="stage-details">
                            <h4>Stage 1: Basic Command Fix</h4>
                            <p class="stage-status">Waiting...</p>
                        </div>
                    </div>
                    <div class="stage pending" id="stage-2">
                        <div class="stage-icon"><i class="fa-solid fa-shield-virus"></i></div>
                        <div class="stage-details">
                            <h4>Stage 2: Windows Defender Quick Scan</h4>
                            <p class="stage-status">Waiting...</p>
                        </div>
                    </div>
                    <div class="stage pending" id="stage-3">
                        <div class="stage-icon"><i class="fa-solid fa-rotate"></i></div>
                        <div class="stage-details">
                            <h4>Stage 3: OS & Driver Update Check</h4>
                            <p class="stage-status">Waiting...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="chat" class="tab-pane hidden">
            <header class="top-bar">
                <h1>Polyglot AI Assistant</h1>
                <div class="user-badge">Language: Auto-Detect</div>
            </header>
            <div class="chat-interface">
                <div class="chat-history" id="chat-history">
                    <div class="message bot">
                        <div class="avatar"><i class="fa-solid fa-robot"></i></div>
                        <div class="bubble">Hello! I am SysMedic. How can I help you today?</div>
                    </div>
                </div>
                <div class="input-area">
                    <input type="text" id="user-input" placeholder="Describe your issue..." onkeypress="handleEnter(event)">
                    <button onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </section>

    </main>

    <div id="permission-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <i class="fa-solid fa-triangle-exclamation warning-icon"></i>
                <h2 id="modal-title">Action Required</h2>
            </div>
            <p id="modal-desc" style="white-space: pre-wrap;"></p>
            
            <div id="update-checklist" class="hidden" style="text-align: left; margin-bottom: 25px; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
            </div>
            
            <div class="modal-actions">
                <button class="btn-ignore" onclick="handleModalChoice(false)">Ignore</button>
                <button class="btn-resolve" onclick="handleModalChoice(true)">
                    <i class="fa-solid fa-shield-halved"></i> Resolve Issue
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { ipcRenderer } = require('electron');

    // --- DASHBOARD VITALS LOGIC ---
    setInterval(() => {
        ipcRenderer.send('request-vitals');
    }, 2000);

    ipcRenderer.on('vitals-update', (event, data) => {
        document.getElementById('cpu-val').innerText = data.cpu;
        document.getElementById('ram-val').innerText = data.ram;
        document.getElementById('temp-val').innerText = data.temp;

        const cpuNum = parseInt(data.cpu);
        if (cpuNum > 80) {
            document.getElementById('cpu-val').classList.add('warning');
        } else {
            document.getElementById('cpu-val').classList.remove('warning');
        }
    });
    
    // --- SIDEBAR TOGGLE LOGIC ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('expanded');
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    }

    function showPlaceholder(feature) {
        alert(`${feature} feature coming soon!`);
    }

    // --- CHAT LOGIC ---
    function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }
    function sendMessage() {
        const input = document.getElementById('user-input');
        if (input.value.trim() === "") return;
        addMessage(input.value, 'user');
        input.value = "";
        setTimeout(() => addMessage("I'm analyzing your request...", 'bot'), 1000);
    }
    function addMessage(text, sender) {
        const history = document.getElementById('chat-history');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender}`;
        const icon = sender === 'bot' ? '<i class="fa-solid fa-robot"></i>' : '<i class="fa-solid fa-user"></i>';
        msgDiv.innerHTML = `<div class="avatar">${icon}</div><div class="bubble">${text}</div>`;
        history.appendChild(msgDiv);
        history.scrollTop = history.scrollHeight;
    }

// --- HEAL LOGIC & STAGES (Connected to Backend) ---
    let scanPausedAtStage = 0; 

    function triggerHeal() {
        const btn = document.getElementById('heal-btn');
        document.getElementById('scan-stages').classList.remove('hidden');
        
        btn.classList.add('healing');
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i><span>SCANNING</span>';
        btn.disabled = true; 

        for(let i=1; i<=3; i++) updateStageUI(i, 'Waiting...', 'pending');

        // Start Stage 1 (Text will be updated by the backend!)
        updateStageUI(1, 'Initializing basic fixes...', 'active');
        ipcRenderer.send('start-stage-1');
    }    

    // NEW LISTENER: Stage 1 Live Progress
    ipcRenderer.on('stage-1-progress', (event, stepText) => {
        updateStageUI(1, stepText, 'active');
    });

    // LISTENER: Stage 1 Done -> Start Stage 2
    ipcRenderer.on('stage-1-complete', (event, response) => {
        updateStageUI(1, 'All basic services restored', 'completed');
        
        // Start Stage 2
        updateStageUI(2, 'Scanning files...', 'active');
        ipcRenderer.send('start-stage-2-scan'); 
    });

    ipcRenderer.on('threat-detected', (event, data) => {
        updateStageUI(2, 'ACTION REQUIRED: Threat found!', 'warning');
        scanPausedAtStage = 2; 
        
        showModal(
            "Threat Detected", 
            `Windows Defender found '${data.threatName}' at location:\n${data.threatLocation}\n\nDo you want SysMedic to quarantine it safely?`
        );
    });

    ipcRenderer.on('scan-2-clean', (event) => {
        updateStageUI(2, 'No threats detected', 'completed');
        resumeScanToStage3(); 
    });

    ipcRenderer.on('threat-resolved', (event, response) => {
        updateStageUI(2, 'Threat removed successfully', 'completed');
        resumeScanToStage3();
    });

    function resumeScanToStage3() {
        updateStageUI(3, 'Checking for updates...', 'active');
        ipcRenderer.send('start-stage-3-scan');
    }

    ipcRenderer.on('updates-found', (event, data) => {
        updateStageUI(3, 'ACTION REQUIRED: Updates available!', 'warning');
        scanPausedAtStage = 3; 
        
        const checklistDiv = document.getElementById('update-checklist');
        checklistDiv.innerHTML = '';
        checklistDiv.classList.remove('hidden'); 

        data.updates.forEach(upd => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.style.marginBottom = '10px';
            label.style.color = 'var(--text-main)';
            label.style.fontSize = '13px';
            label.style.cursor = 'pointer';
            
            label.innerHTML = `<input type="checkbox" value="${upd.id}" checked class="update-cb" style="margin-right: 10px; accent-color: var(--accent);"> ${upd.name}`;
            checklistDiv.appendChild(label);
        });

        showModal("System Updates Available", "Please select the updates you want to install:");
    });

    ipcRenderer.on('updates-resolved', (event) => {
        updateStageUI(3, 'System is up to date', 'completed');
        finishScan();
    });

    // --- MODAL LOGIC ---
    function showModal(title, desc) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-desc').innerText = desc;
        document.getElementById('permission-modal').classList.remove('hidden');
    }

    function handleModalChoice(isApproved) {
        document.getElementById('permission-modal').classList.add('hidden');
        document.getElementById('update-checklist').classList.add('hidden'); 
        
        if (scanPausedAtStage === 2) {
            if (isApproved) {
                updateStageUI(2, 'Quarantining threat...', 'active');
                ipcRenderer.send('resolve-threat'); 
            } else {
                updateStageUI(2, 'Ignored by user', 'completed');
                resumeScanToStage3();
            }
        } else if (scanPausedAtStage === 3) {
            if (isApproved) {
                const checkboxes = document.querySelectorAll('.update-cb:checked');
                const selectedIds = Array.from(checkboxes).map(cb => cb.value);

                if (selectedIds.length === 0) {
                    updateStageUI(3, 'No updates selected', 'completed');
                    finishScan();
                    return;
                }

                updateStageUI(3, `Installing ${selectedIds.length} update(s)...`, 'active');
                ipcRenderer.send('resolve-updates', selectedIds); 
            } else {
                updateStageUI(3, 'Update skipped by user', 'completed');
                finishScan();
            }
        }
    }

    function finishScan() {
        const btn = document.getElementById('heal-btn');
        btn.classList.remove('healing');
        btn.innerHTML = '<i class="fa-solid fa-check"></i><span>SYSTEM HEALTHY</span>';
        btn.style.borderColor = "#10b981"; 
        btn.style.background = "radial-gradient(circle, #059669 0%, #064e3b 100%)";
        
        setTimeout(() => { 
            btn.disabled = false; 
            btn.style.borderColor = ""; 
            btn.style.background = "";
            btn.innerHTML = '<i class="fa-solid fa-power-off"></i><span>INITIATE SCAN</span>';
        }, 5000);
    }

    function updateStageUI(stageNum, text, status) {
        const st = document.getElementById('stage-' + stageNum);
        st.className = `stage ${status}`;
        st.querySelector('.stage-status').innerText = text;
        
        const iconContainer = st.querySelector('.stage-icon');
        if(status === 'completed') {
            iconContainer.innerHTML = '<i class="fa-solid fa-check"></i>';
            st.style.borderColor = ""; 
        } 
        else if (status === 'active') {
            iconContainer.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
            st.style.borderColor = ""; 
        } 
        else if (status === 'warning') {
            iconContainer.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i>';
            st.style.borderColor = "#facc15"; 
            iconContainer.style.background = "#facc15";
            iconContainer.style.color = "#000";
        } 
        else if (status === 'pending') {
            const icons = ['fa-terminal', 'fa-shield-virus', 'fa-rotate'];
            iconContainer.innerHTML = `<i class="fa-solid ${icons[stageNum-1]}"></i>`;
        }
    }
</script>
</body>
</html>